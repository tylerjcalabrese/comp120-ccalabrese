let map,markers,userLoc,userMarker,infowindow;const carIcon="https://tuftsdev.github.io/WebEngineering/assignments/summer2021/car.png";function distanceFromUser(e){return milesFromMeters(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng({lat:e.position.lat(),lng:e.position.lng()}),new google.maps.LatLng({lat:userLoc.lat,lng:userLoc.lng})))}function milesFromMeters(e){return e/1609.34}function markSelfWithClosestCar(e){userMarker=new google.maps.Marker({map:map,position:userLoc});let o=e[0];e.forEach(e=>{distanceFromUser(e)<distanceFromUser(o)&&(o=e)});let n="The closest car is at ("+o.position.lat+", "+o.position.lng+"), and is "+distanceFromUser(o).toFixed(0)+" miles away.";infowindow=new google.maps.InfoWindow({content:n}),userMarker.addListener("click",()=>{infowindow.open({anchor:userMarker,map:map})}),new google.maps.Polyline({map:map,path:[{lat:userLoc.lat,lng:userLoc.lng},{lat:o.position.lat(),lng:o.position.lng()}]})}function posSuccess(e){userLoc={lat:e.coords.latitude,lng:e.coords.longitude},map.setCenter(userLoc),xhr=new XMLHttpRequest,xhr.open("POST","https://jordan-marsh.herokuapp.com/rides"),xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xhr.onreadystatechange=(()=>{if(4==xhr.readyState&&200==xhr.status){let e=JSON.parse(xhr.responseText);markerinfo=e.map(e=>({map:map,position:{lat:e.lat,lng:e.lng},icon:carIcon,id:e.id,username:e.username,created_on:e.created_on})),mapmarkers=markerinfo.map(e=>new google.maps.Marker(e)),mapmarkers.forEach(e=>{let o=new google.maps.InfoWindow({content:distanceFromUser(e).toFixed(0)+" miles away"});e.addListener("click",()=>{o.open({anchor:e,map:map})})}),markSelfWithClosestCar(mapmarkers)}});let o="username=xXoDw780&lat="+e.coords.latitude+"&lng="+e.coords.longitude;console.log("sending API request"),xhr.send(o)}function posError(e){console.log("there was an error getting pos",e.message)}function initMap(){navigator.geolocation.getCurrentPosition(posSuccess,posError),console.log("creating map"),map=new google.maps.Map(document.getElementById("map"),{center:{lat:42.352271,lng:-71.055242},zoom:12})}
